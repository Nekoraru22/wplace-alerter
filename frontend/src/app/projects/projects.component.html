<!-- Project List -->
<div class="container-fluid m-0 p-0">

    <div class="d-flex w-100 page">
        <div class="section d-flex flex-column projects-box">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Project List</h2>
                <button class="btn btn-sm btn-outline-secondary" (click)="toggleProjectOrder()" title="Toggle sort order">
                    <span *ngIf="reversedOrder">↓</span>
                    <span *ngIf="!reversedOrder">↑</span>
                </button>
            </div>

            <div class="flex-grow-1 overflow-auto pb-3 pt-3">
                @for (project of displayedProjects; track project) {
                    <div class="card mb-3" style="cursor: pointer;" (click)="selectProject(project)">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <div class="d-flex flex-column">
                                    <div class="d-flex align-items-center">
                                        <div class="status-circle me-3" [ngClass]="getStatus(project)" placement="top"></div>
                                        <h5 class="card-title mb-1">{{project.name}}</h5>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="status-circle me-3 hidden" placement="top"></div>
                                        <span class="text-muted small">Last checked: {{ project.last_checked || 'Never' }}</span>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary" (click)="$event.stopPropagation(); checkProject(project, $event)">Check</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="d-flex projects-box-buttons">
                <button class="btn btn-primary w-100" (click)="checkAllProjects()" [disabled]="checkingAll">
                    <span *ngIf="checkingAll" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Check All
                </button>
                <button class="btn btn-outline-primary w-100 ms-2" (click)="openModal(newProjectModal)">Add new</button>
            </div>
        </div>

        <!-- Selected project details -->
        <div class="section overflow-auto">
            @if (selectedProject && editedProject) {
                <div class="d-flex align-items-center">
                    <div class="status-circle me-3" [ngClass]="getStatus(selectedProject)" placement="top">
                    </div>
                    <h2 class="">{{selectedProject.name}}</h2>
                </div>
                <span class="text-muted small">Last checked: {{ selectedProject.last_checked }}</span>
                <div class="text-center mb-3 d-flex justify-content-center project-images">
                    <div class="d-flex flex-column align-items-center w-100">
                        @if (isImgLoading) {
                            <div class="spinner-border m-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        }
                        <img
                            [src]="serverService.getBaseUrl() + 'data/' + selectedProject.name + '/original.png?t=' + imageTimestamp"
                            alt="Original Image"
                            class="project-image px-3"
                            [style.display]="isImgLoading ? 'none' : 'block'"
                            (load)="isImgLoading = false"
                            (error)="onImageError($event)"
                        >
                        <div class="mt-1 mb-2">Original</div>
                    </div>
                    <div class="d-flex flex-column align-items-center w-100">
                        @if (isImgLoading) {
                            <div class="spinner-border m-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        }
                        <img
                            [src]="serverService.getBaseUrl() + 'data/' + selectedProject.name + '/new.png?t=' + imageTimestamp"
                            alt="New Image"
                            class="project-image px-3"
                            [style.display]="isImgLoading ? 'none' : 'block'"
                            (load)="isImgLoading = false"
                            (error)="onImageError($event)"
                        >
                        <div class="mt-1 mb-2">New</div>
                    </div>
                </div>
                <form (ngSubmit)="saveProjectChanges()">
                    <div class="mb-3">
                        <strong><label for="apiImage" class="form-label">API Image</label></strong>
                        <input type="text" class="form-control" id="apiImage" 
                            [(ngModel)]="editedProject.api_image" 
                            (ngModelChange)="onProjectChange()"
                            name="apiImage">
                    </div>
                    <div class="mb-3 d-flex align-items-center">
                        <input type="checkbox" class="form-check-input m-0 p-0" id="tracking" 
                            [(ngModel)]="editedProject.track" 
                            (ngModelChange)="onProjectChange()"
                            name="tracking">
                        <label for="tracking" class="form-label m-0 p-0 ms-1">Tracking</label>
                        <input type="checkbox" class="form-check-input m-0 p-0 ms-3" id="checkTransparent" 
                            [(ngModel)]="editedProject.check_transparent_pixels" 
                            (ngModelChange)="onProjectChange()"
                            name="checkTransparent">
                        <label for="checkTransparent" class="form-label m-0 p-0 ms-1">Check Transparent</label>
                    </div>
                    <div class="mb-3">
                        <strong><label for="startCoords" class="form-label">Start Coords</label></strong>
                        <div class="d-flex align-items-center">
                            <label class="me-1" for="startCoordsX">X:</label>
                            <input type="text" class="form-control" id="startCoordsX" 
                                [(ngModel)]="editedProject.start_coords.x" 
                                (ngModelChange)="onProjectChange()"
                                name="startCoordsX">
                            <label class="me-1 ms-2" for="startCoordsY">Y:</label>
                            <input type="text" class="form-control" id="startCoordsY" 
                                [(ngModel)]="editedProject.start_coords.y" 
                                (ngModelChange)="onProjectChange()"
                                name="startCoordsY">
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong><label for="endCoords" class="form-label">End Coords</label></strong>
                        <div class="d-flex align-items-center">
                            <label class="me-1" for="endCoordsX">X:</label>
                            <input type="text" class="form-control" id="endCoordsX" 
                                [(ngModel)]="editedProject.end_coords.x" 
                                (ngModelChange)="onProjectChange()"
                                name="endCoordsX">
                            <label class="me-1 ms-2" for="endCoordsY">Y:</label>
                            <input type="text" class="form-control" id="endCoordsY" 
                                [(ngModel)]="editedProject.end_coords.y" 
                                (ngModelChange)="onProjectChange()"
                                name="endCoordsY">
                        </div>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary" [disabled]="!hasChanges">Save Changes</button>
                        <button type="button" class="btn btn-secondary ms-2" (click)="checkProject(selectedProject, $event)">Check</button>
                        <button type="button" class="btn btn-danger ms-2" (click)="deleteProject(selectedProject)">Delete</button>
                    </div>
                </form>
            }
            @else {
                <div class="d-flex justify-content-center align-items-center h-100">
                    <span class="text-muted">Select a project to view details</span>
                </div>
            }
        </div>

        <!-- Terminal -->
        <div class="w-100 terminal-box d-flex flex-column">
            <h4 class="terminal-title">Console</h4>
            <div class="terminal-chat">
                <div style="white-space: pre-line;">{{ terminalLogs }}</div>
            </div>

            @if (selectedProject && selectedProject.griefed) {
                <h4 class="terminal-title mt-2">Fix command</h4>
                <div class="terminal-chat code-container">
                    <button class="copy-button" (click)="copyCode()" [title]="copied ? 'Copied!' : 'Copy code'">
                        <span *ngIf="!copied">Copy</span>
                        <span *ngIf="copied">✓</span>
                    </button>
                    <pre><code class="language-javascript">{{ fixCommand }}</code></pre>
                </div>
            }

            <div class="config-buttons d-flex justify-content-end mt-2">
                <button class="btn btn-outline-primary" (click)="loadColors(); openBottom(colorsModal)">Colors</button>
                <button class="btn btn-outline-primary ms-2" (click)="openModal(automateModal)">Automate</button>
            </div>
        </div>
    </div>

</div>

<!-- New Project Modal -->
<ng-template #newProjectModal let-modal>
	<div class="modal-header">
		<h4 class="modal-title">Create New Project</h4>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
	</div>

	<div class="modal-body">
		<form #newProjectForm="ngForm">
            <div class="mb-3">
                <label for="projectName-modal" class="form-label">Project Name</label>
                <input type="text" class="form-control" id="projectName-modal"
                    [(ngModel)]="newProject.name"
                    name="projectName-modal"
                    required
                    (ngModelChange)="newProject.name = newProject.name.trim()"
                    #projectName="ngModel">
                @if (projectName.invalid && projectName.touched) {
                    <small class="text-danger">Project name is required</small>
                }
            </div>
            <div class="mb-3">
                <label for="apiImage-modal" class="form-label">API Image URL</label>
                <input type="text" class="form-control" id="apiImage-modal"
                    [(ngModel)]="newProject.api_image"
                    name="apiImage-modal"
                    required
                    (ngModelChange)="newProject.api_image = newProject.api_image.trim()"
                    #apiImage="ngModel">
                @if (apiImage.invalid && apiImage.touched) {
                    <small class="text-danger">API Image URL is required</small>
                }
            </div>
            <div class="mb-3">
                <div class="form-check form-check-inline">
                    <input type="checkbox" class="form-check-input" id="tracking-modal"
                        [(ngModel)]="newProject.track"
                        name="tracking-modal">
                    <label class="form-check-label" for="tracking-modal">Tracking</label>
                </div>
                <div class="form-check form-check-inline ms-3">
                    <input type="checkbox" class="form-check-input" id="checkTransparent-modal"
                        [(ngModel)]="newProject.check_transparent_pixels"
                        name="checkTransparent-modal">
                    <label class="form-check-label" for="checkTransparent-modal">Check Transparent</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Start Coords</label>
                <div class="row g-2">
                    <div class="col">
                        <label class="form-label small" for="startCoordsX-modal">X:</label>
                        <input type="number" class="form-control" id="startCoordsX-modal"
                            [(ngModel)]="newProject.start_coords.x"
                            name="startCoordsX-modal"
                            required
                            (ngModelChange)="newProject.start_coords.x = +$event"
                            #startX="ngModel">
                    </div>
                    <div class="col">
                        <label class="form-label small" for="startCoordsY-modal">Y:</label>
                        <input type="number" class="form-control" id="startCoordsY-modal"
                            [(ngModel)]="newProject.start_coords.y"
                            name="startCoordsY-modal"
                            required
                            (ngModelChange)="newProject.start_coords.y = +$event"
                            #startY="ngModel">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">End Coords</label>
                <div class="row g-2">
                    <div class="col">
                        <label class="form-label small" for="endCoordsX-modal">X:</label>
                        <input type="number" class="form-control" id="endCoordsX-modal"
                            [(ngModel)]="newProject.end_coords.x"
                            name="endCoordsX-modal"
                            required
                            (ngModelChange)="newProject.end_coords.x = +$event"
                            #endX="ngModel">
                    </div>
                    <div class="col">
                        <label class="form-label small" for="endCoordsY-modal">Y:</label>
                        <input type="number" class="form-control" id="endCoordsY-modal"
                            [(ngModel)]="newProject.end_coords.y"
                            name="endCoordsY-modal"
                            required
                            (ngModelChange)="newProject.end_coords.y = +$event"
                            #endY="ngModel">
                    </div>
                </div>
            </div>
        </form>

        @if (errorMessage) {
            <div class="alert alert-danger" role="alert">
                {{ errorMessage }}
            </div>
        }
	</div>
    
	<div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="addNewProject()" [disabled]="newProjectForm.invalid">Create Project</button>
		<button type="button" class="btn btn-outline-secondary" (click)="modal.close()">Cancel</button>
	</div>
</ng-template>

<!-- Automate Modal -->
<ng-template #automateModal let-modal>
	<div class="modal-header">
        <div class="d-flex align-items-center">
            <div class="status-circle me-2" [ngClass]="automatedChecks ? 'status-circle-green' : 'status-circle-gray'" placement="top"></div>
            <h4 class="modal-title">Automate Project Checks</h4>
        </div>
		<button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
	</div>

	<div class="modal-body">
		<form #automateForm="ngForm">
            <div class="mb-3">
                <label for="discord-modal" class="form-label">Discord Webhook URL</label>
                <input type="url" class="form-control" id="discord-modal" 
                    [(ngModel)]="discordWebhook" 
                    name="discord-modal" 
                    required
                    placeholder="https://discord.com/api/webhooks/..."
                    #discord="ngModel">
                @if (discord.invalid && discord.touched) {
                    <small class="text-danger">Valid Discord webhook URL is required</small>
                }
            </div>
            <div class="mb-3">
                <label for="cooldown-modal" class="form-label">Cooldown Between Checks (seconds)</label>
                <input type="number" class="form-control" id="cooldown-modal" 
                    [(ngModel)]="cooldownBetweenChecks" 
                    name="cooldown-modal" 
                    required
                    min="1"
                    placeholder="60"
                    #cooldown="ngModel">
                @if (cooldown.invalid && cooldown.touched) {
                    <small class="text-danger">Cooldown must be at least 1 second</small>
                }
            </div>
        </form>

        @if (errorMessage) {
            <div class="alert alert-danger" role="alert">
                {{ errorMessage }}
            </div>
        }
	</div>
    
	<div class="modal-footer">
        <button type="button" 
            class="btn btn-outline-{{ automatedChecks ? 'danger' : 'success' }}" 
            (click)="toggleAutomationChecks()">
            {{ automatedChecks ? 'Stop' : 'Start' }} Automated Checks
        </button>
        <button type="button" class="btn btn-primary" (click)="updateAutomationSettings()" [disabled]="automateForm.invalid">Save Settings</button>
        <button type="button" class="btn btn-outline-secondary" (click)="modal.close()">Close</button>
	</div>
</ng-template>

<!-- Colors Modal -->
<ng-template #colorsModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">Color Settings</h4>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
    </div>

    <div class="modal-body p-3">
        <form>
            <div class="colors-grid">
                @for (color of colors; track color; let i = $index) {
                    <div class="form-check p-0 m-0">
                        <input 
                            class="form-check-input d-none" 
                            type="checkbox" 
                            [(ngModel)]="color.enabled" 
                            name="color-{{i}}" 
                            id="color-{{i}}"
                        >
                        <label 
                            class="form-check-label color-box" 
                            [class.selected]="color.enabled"
                            for="color-{{i}}"
                            [style.background-color]="'rgba(' + color.rgb[0] + ',' + color.rgb[1] + ',' + color.rgb[2] + ',' + (color.name == 'TRANSPARENT' ? '0.1' : '1') + ')'"
                            [ngbTooltip]="color.name"
                            placement="top"
                            container="body">
                        </label>
                    </div>
                }
            </div>
        </form>
    </div>

    <div class="modal-footer d-flex justify-content-between">
        <div>
            <button type="button" class="btn btn-outline-primary" (click)="selectAllColors()">Select All</button>
            <button type="button" class="btn btn-outline-primary ms-2" (click)="deselectAllColors()">Deselect All</button>
            <button type="button" class="btn btn-outline-primary ms-2" (click)="selectFree()">Free Colors</button>
        </div>
        <div>
            <button type="button" class="btn btn-primary" (click)="saveColorSettings()">Update</button>
            <button type="button" class="btn btn-outline-secondary ms-2" (click)="modal.close()">Close</button>
        </div>
    </div>
</ng-template>